\section{Control via I/O feedback linearization}
From the control perspective, Ingenuity is an underactuated robot, since the number of control inputs is less than the number of degrees of freedom. Specifically, it has six degrees of freedom (three for the position and three for the orientation) and only four control inputs (the rotation speed of the two rotors $\omega_u$ and $\omega_l$, and the thrust vector angles $\alpha$ and $\beta$). 

In order for the robot to be controlled, it is necessary to exploit its natural dynamics by employing the four inputs  to impart a certain behavior to the total system (both positional and rotational state variables) such that, at the end of the day, the three-dimensional position and the yaw angle follow the desired course in time. To grasp the concept, the reader can imagine a quadrotor or helicopter with a tail rotor, which need to tilt in the desired direction in order to move.

If we choose as controlled outputs of the system the three position components and the yaw angle, it is possible to employ the input-to-output feedback linearization technique to design a controller that renders unobservable the nonlinear dynamics of the helicopter. As a result, the system seen between input and output will have linear dynamics and thus could be easily controlled via linear control techniques.

Consider the following nonlinear state-space representation of the robot dynamics:
\begin{align}
    \frac{d}{dt} \begin{bmatrix}
        P \\ V^b \\ W \\ \Omega^b
    \end{bmatrix} = \begin{bmatrix}
        R \, V^b \\ \frac{1}{m} R^T F_g^i -\Omega^b \times V^b + \frac{1}{m} u \\ R \, \Omega^b \\ -I^{-1} \Omega^b \times (I \Omega^b)+I^{-1}\tau_{tot}^b 
    \end{bmatrix}
    \label{eq:fbl_model}
\end{align}
where the input $u$ is the total thrust force generated by the rotors: 
\begin{align}
    u = F_u^b + F_l^b.    
    \label{eq:u} 
\end{align}
Calculations are facilitated if we make a change of coordinates to the inertial frame. 
$$ \frac{d}{dt} \begin{bmatrix}
    P \\ \dot{P}
\end{bmatrix} = \begin{bmatrix}
    \dot{P} \\ \frac{1}{m} F_g^i + \Omega^b \times \dot{P} - (R \Omega^b) \times \dot{P} + \frac{1}{m} R u
\end{bmatrix}. $$

The idea is to choose $u$ to cancel the nonlinear part of the positional dynamics:
$$u = m R^T [(R \Omega^b) \times \dot{P} - \Omega^b \times \dot{P} - \frac{1}{m} F_g^i + v].$$
The transfer function relating the input $v$ to the output $P$ is then a double integrator:
$$\frac{d^2}{dt^2} P(t) = v(t) \iff \frac{P(s)}{v(s)} = \frac{1}{s^2}.$$
It can be controlled using a simple PD controller with a feedforward term:
$$v = k_{p,1} (P_d - P) + k_d \bigg(\frac{d}{dt}P_d - \dot{P}\bigg) + \frac{d^2}{dt^2}P_d.$$

Notice that the only input affecting the $\Omega_3^b$ dynamics is the reaction torque $\tau_r^b$. Controlling the third component of the angular velocity in the body frame is all we can do if we want to keep the inputs $u$ and $\tau_r^b$ decoupled, and it is sufficient if we assume that the roll and pitch angles are sufficiently small. Therefore, we proceed in an analogous way to the previous case, choosing:

$$ \tau_r^b = \begin{bmatrix}
    0 & 0 & 0 \\ 0 & 0 & 0 \\ 0 & 0 & 1
\end{bmatrix}[\Omega^b \times (I \Omega^b) + I w]$$
This results in the following transfer function for the $\Omega_3^b$ dynamics:
$$\frac{d}{dt} \Omega_3^b(t) = w_3(t) \iff \frac{\Omega_3^b(s)}{w_3(s)} = \frac{1}{s},$$
where $w_3$ is the third component of $w$. The linearized system can be controlled using a simple proportional controller with a feedforward term:
$$w = \begin{bmatrix}
    0 \\ 0 \\k_{p,2} (\Omega_{3,d}^b - \Omega_3^b) + \frac{d}{dt}\Omega_{3,d}^b
\end{bmatrix} .$$

Following this, a critical point is reached: once an feedback linearizing control is implemented, it is worth taking a look at how the part of the system that has been hidden behaves. We could call this part, in a non-formal way, the \textit{forced zero dynamics} of the system. It is obtained by substituting \ref{eq:torque_due_force} and \ref{eq:torque} in \ref{eq:fbl_model}:
\begin{align*}
    \frac{d}{dt}\begin{bmatrix}
        \Omega^b_1 \\
        \Omega^b_2
    \end{bmatrix}
    = 
    \begin{bmatrix}
        -\frac{F_{l,2}^b d_{cm,l} + F_{u,2}^b d_{cm,u}}{I_{1,1}} - \frac{I_{2,2}-I_{3,3}}{I_{1,1}} \Omega^b_2 \Omega^b_3 \\
        \frac{F_{l,1}^b d_{cm,l} + F_{u,1}^b d_{cm,u}}{I_{2,2}} + \frac{I_{1,1}-I_{3,3}}{I_{2,2}} \Omega^b_1 \Omega^b_3
    \end{bmatrix}.
\end{align*}
The latter is an autonomous dynamics that is affected by the signals $F_{l,1}^b$, $F_{l,2}^b$, $F_{u,1}^b$ and $F_{u,2}^b$, which in turn depend on the feedback linearizing control. In practical terms, in order to enforce the designed behavior, the controller may induce pseudo-chaotic angular accelerations in the not-directly-controllable part of the system, leading to undesired and "clumsy" behaviors. It is a consequence of the fact that the system is underactuated.

\input{sections/fbl_actuation.tex}
\input{sections/fbl_sim.tex}